# Offline Docker Setup for Trust Assembly

This setup allows you to build and run the Trust Assembly application completely offline, without requiring internet access during build or runtime.

## 🎯 Overview

The offline setup addresses these key challenges:
- **Deno dependencies**: Caches JSR and npm packages locally
- **Python dependencies**: Downloads and caches PyPI packages as wheels
- **Base images**: Saves Docker images locally for offline loading
- **Database migrations**: Uses cached Nessie CLI instead of downloading

## 📋 Files Created

### Docker Files
- `Dockerfile.offline` - Production offline Dockerfile
- `Dockerfile.dev.offline` - Development offline Dockerfile
- `docker-compose.offline.yml` - Production offline compose configuration
- `docker-compose.dev.offline.yml` - Development offline compose configuration

### Scripts
- `prepare-offline.sh` - Initial setup script (requires internet)
- `build-offline.sh` - Build images offline (generated by prepare script)
- `run-offline.sh` - Run application offline (generated by prepare script)
- `test-offline.sh` - Test offline setup

### Documentation
- `OFFLINE-SETUP.md` - Quick start guide
- `OFFLINE-DOCKER-README.md` - This comprehensive guide

## 🚀 Quick Start

### 1. Prepare for Offline Operation (One-time, requires internet)

```bash
./prepare-offline.sh
```

This will:
- Pull all required Docker base images
- Cache Deno and npm dependencies
- Cache Python packages
- Generate build and run scripts
- Save everything to `.docker-cache/`

### 2. Build Offline

```bash
./build-offline.sh
```

### 3. Run Offline

```bash
# Development mode
./run-offline.sh dev

# Production mode
./run-offline.sh prod
```

### 4. Test Setup

```bash
./test-offline.sh
```

## 🔧 Technical Details

### Multi-Stage Build Strategy

The offline Dockerfiles use a multi-stage approach:

1. **Dependency Cache Stage**: Downloads and caches all external dependencies
2. **Python Cache Stage**: Downloads Python packages as wheels
3. **Migrator Stage**: Database migration tools with cached dependencies
4. **Transform Builder Stage**: Builds Python package offline
5. **Main Application Stage**: Final application with all cached dependencies

### Cached Dependencies

#### Deno/Node.js
- Hono web framework
- Sessions middleware
- Jose JWT library
- Vite build tool
- TypeScript compiler
- Nessie database migration tool

#### Python
- OpenAI library
- Build tools (pip, setuptools, wheel, build)

#### Base Images
- `denoland/deno:2.1.1`
- `python:3.9-alpine`  
- `postgres:17.2`

### Network Configuration

The compose files include:
```yaml
networks:
  offline-network:
    driver: bridge
    internal: false  # Change to true for enforced offline operation
```

Set `internal: true` to completely prevent external network access.

## 🎛️ Configuration Options

### Environment Variables

The application uses these environment variables (defined in `apps/webapp/db.local.env`):
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `POSTGRES_DB`
- `POSTGRES_HOST`

### Ports

- **Development**: `5173` (webapp), `5432` (postgres)
- **Production**: `8001` (webapp), `5432` (postgres)

### Volumes

- `trust_assembly_data_offline` - Production database
- `trust_assembly_data_offline_dev` - Development database

## 🧪 Testing

### Validate Setup

```bash
./test-offline.sh
```

### Manual Testing

1. **Disconnect from internet**
2. **Build offline**: `./build-offline.sh`
3. **Run offline**: `./run-offline.sh dev`
4. **Access application**: http://localhost:5173

### Expected Behavior

- ✅ Application starts without internet access
- ✅ Database migrations run successfully
- ✅ Frontend and API are accessible
- ✅ No external network requests during build or runtime

## 🛠️ Troubleshooting

### Common Issues

#### "No such file or directory" during build
- **Cause**: Cache not prepared
- **Solution**: Run `./prepare-offline.sh` first

#### "Cannot connect to database"
- **Cause**: PostgreSQL not ready
- **Solution**: Wait for health check, check database environment variables

#### "Module not found" errors
- **Cause**: Incomplete dependency cache
- **Solution**: Re-run preparation script with internet access

#### "Task not found" errors  
- **Cause**: Deno tasks not properly configured
- **Solution**: Verify `apps/webapp/deno.json` includes task definitions

### Debug Commands

```bash
# Check Docker images
docker images

# Check running containers
docker ps

# View container logs
docker-compose -f docker-compose.dev.offline.yml logs webapp

# Verify cache contents
ls -la .docker-cache/

# Test Docker compose syntax
docker-compose -f docker-compose.offline.yml config
```

## 🔄 Updating Dependencies

To update cached dependencies:

1. **Delete cache**: `rm -rf .docker-cache/`
2. **Re-prepare**: `./prepare-offline.sh`
3. **Rebuild**: `./build-offline.sh`

## 🎯 Use Cases

### Air-Gapped Environments
Perfect for environments with no internet access:
- Secure development environments
- Offline demonstrations
- Network-isolated testing

### CI/CD Pipelines
Reliable builds without external dependencies:
- Consistent build times
- No network failures
- Reproducible environments

### Edge Deployments
Deploy to locations with limited connectivity:
- Remote locations
- Bandwidth-constrained environments
- Unreliable internet connections

## 📚 Additional Resources

- [Docker Multi-stage Builds](https://docs.docker.com/develop/dev-best-practices/use-multi-stage-builds/)
- [Deno Caching](https://deno.land/manual/linking_to_external_code)
- [Docker Compose Networks](https://docs.docker.com/compose/networking/)

## 🤝 Contributing

When adding new dependencies:

1. Update the appropriate Dockerfile cache stage
2. Update `prepare-offline.sh` to cache new dependencies
3. Test with `./test-offline.sh`
4. Update this documentation

## 📄 License

Same as main project license.